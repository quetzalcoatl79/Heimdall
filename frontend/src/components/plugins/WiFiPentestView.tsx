'use client';

import { useState, useEffect, useMemo } from 'react';
import { useQuery, useMutation, useQueryClient } from '@tanstack/react-query';
import { apiClient } from '@/lib/api/client';
import {
  Wifi,
  RefreshCw,
  Radio,
  Signal,
  Lock,
  Unlock,
  Play,
  Square,
  CheckSquare,
  AlertCircle,
  Loader2,
  Download,
  WifiOff,
  StopCircle,
  Key,
  FileText,
  Trash2,
  CheckCircle,
  XCircle,
  Clock,
  Zap,
  X,
  Info,
} from 'lucide-react';

interface WiFiNetwork {
  ssid: string;
  bssid: string;
  channel: number;
  signal: number;
  security: string;
  vendor?: string;
  wps?: string;
  interface: string;
  last_seen: string;
}

interface WiFiInterface {
  name: string;
  mac: string;
  monitor: boolean;
  up: boolean;
  driver?: string;
}

interface CaptureFile {
  id?: string;
  path: string;
  name: string;
  size: number;
  modified?: string;
  has_handshake: boolean;
  // New fields from database
  ssid?: string;
  bssid?: string;
  channel?: number;
  security?: string;
  interface?: string;
  duration?: number;
  started_at?: string;
  ended_at?: string;
  status?: string;
  cracked?: boolean;
  password?: string;
  cap_file?: string;
}

interface Wordlist {
  path: string;
  name: string;
  size: number;
  lines: number;
}

interface BruteforceResult {
  success: boolean;
  password?: string;
  ssid: string;
  bssid: string;
  capture: string;
  wordlist: string;
  duration_seconds: number;
  tested_at: string;
}

interface BruteforceStatus {
  running: boolean;
  capture?: string;
  started_at?: string;
  duration?: number;
  result?: BruteforceResult;
}

// Dur√©e de capture par r√©seau
interface NetworkCaptureDuration {
  bssid: string;
  ssid: string;
  duration: number;
}

// Password pattern for ISPs
interface PasswordPattern {
  isp: string;
  description: string;
  length: string;
  character_set: string;
  format: string;
  example: string;
  generator_type: string;
  mask_pattern?: string;
  notes?: string;
}

// Vendor analysis response
interface VendorAnalysis {
  bssid: string;
  ssid: string;
  vendor?: {
    manufacturer: string;
    isp?: string;
    router_model?: string;
    country?: string;
  };
  isp?: string;
  has_pattern?: boolean;
  password_pattern?: PasswordPattern;
}

const DURATION_OPTIONS = [
  { value: 60, label: '1 minute', hint: 'Test rapide' },
  { value: 300, label: '5 minutes', hint: 'Recommand√© WPA2' },
  { value: 600, label: '10 minutes', hint: '' },
  { value: 1800, label: '30 minutes', hint: 'WPA3/WEP' },
  { value: 3600, label: '1 heure', hint: '' },
  { value: 0, label: 'Illimit√©', hint: 'Arr√™t manuel' },
];

export function WiFiPentestView() {
  const queryClient = useQueryClient();
  const [selectedInterface, setSelectedInterface] = useState<string>('');
  const [selectedNetworks, setSelectedNetworks] = useState<Set<string>>(new Set());
  const [isScanning, setIsScanning] = useState(false);
  const [isCapturing, setIsCapturing] = useState(false);
  const [captureStatus, setCaptureStatus] = useState<string | null>(null);
  
  // Modal de confirmation capture
  const [showCaptureModal, setShowCaptureModal] = useState(false);
  const [captureConfigs, setCaptureConfigs] = useState<NetworkCaptureDuration[]>([]);
  
  // Bruteforce state
  const [selectedCapture, setSelectedCapture] = useState<string>('');
  const [selectedWordlist, setSelectedWordlist] = useState<string>('');
  const [targetBssid, setTargetBssid] = useState<string>('');
  const [targetSsid, setTargetSsid] = useState<string>('');
  const [activeTab, setActiveTab] = useState<'scan' | 'captures' | 'crack'>('scan');

  // Deauth state
  const [deauthTarget, setDeauthTarget] = useState<{ bssid: string; ssid: string; channel: number } | null>(null);
  const [deauthCount, setDeauthCount] = useState<number>(10);
  const [isDeauthing, setIsDeauthing] = useState(false);

  // Vendor analysis state
  const [vendorAnalysis, setVendorAnalysis] = useState<VendorAnalysis | null>(null);
  const [showVendorModal, setShowVendorModal] = useState(false);

  // Fetch interfaces
  const { data: interfacesData, refetch: refetchInterfaces, isFetching: isRefreshingInterfaces } = useQuery({
    queryKey: ['wifi', 'interfaces'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/interfaces');
      return res.data?.interfaces as WiFiInterface[];
    },
  });

  // Fetch scan results
  const { data: scanData, refetch: refetchScan } = useQuery({
    queryKey: ['wifi', 'scan-results'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/scan/results');
      return res.data;
    },
    refetchInterval: isCapturing ? 5000 : 10000,
  });

  // D√©dupliquer les r√©seaux par BSSID (garder celui avec le meilleur signal)
  const networks: WiFiNetwork[] = useMemo(() => {
    const rawNetworks: WiFiNetwork[] = scanData?.results || [];
    const networkMap = new Map<string, WiFiNetwork>();
    
    for (const network of rawNetworks) {
      const existing = networkMap.get(network.bssid);
      if (!existing || network.signal > existing.signal) {
        networkMap.set(network.bssid, network);
      }
    }
    
    return Array.from(networkMap.values());
  }, [scanData]);

  // Auto-select first interface
  useEffect(() => {
    if (interfacesData?.length && !selectedInterface) {
      const firstUp = interfacesData.find((i) => i.up);
      setSelectedInterface(firstUp?.name || interfacesData[0].name);
    }
  }, [interfacesData, selectedInterface]);

  // Capture status polling - poll quand capture en cours OU au chargement pour sync l'√©tat
  const { data: captureStatusData } = useQuery({
    queryKey: ['wifi', 'capture', 'status'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/capture/status');
      return res.data;
    },
    // Poll toutes les 5s pendant la capture, ou toutes les 30s quand sur l'onglet scan
    refetchInterval: isCapturing ? 5000 : (activeTab === 'scan' ? 30000 : false),
  });

  // Synchroniser l'√©tat isCapturing au premier chargement
  useEffect(() => {
    if (captureStatusData?.running && !isCapturing) {
      setIsCapturing(true);
      const targets = captureStatusData.targets?.length || 0;
      const sizeKB = ((captureStatusData.cap_size || 0) / 1024).toFixed(1);
      setCaptureStatus(
        `üì° Capture en cours... ${targets} cible(s) | ${sizeKB} KB captur√©s`
      );
    }
  }, [captureStatusData?.running]); // eslint-disable-line react-hooks/exhaustive-deps

  // Scan mutation
  const scanMutation = useMutation({
    mutationFn: async () => {
      setIsScanning(true);
      const res = await apiClient.post('/plugins/wifi/scan', {
        interface: selectedInterface,
      });
      return res.data;
    },
    onSuccess: () => {
      refetchScan();
      setIsScanning(false);
    },
    onError: () => {
      setIsScanning(false);
    },
  });

  // Capture mutation
  const captureMutation = useMutation({
    mutationFn: async (params: { targets: string[]; duration: number }) => {
      setIsCapturing(true);
      setCaptureStatus('D√©marrage de la capture...');
      const res = await apiClient.post('/plugins/wifi/capture', {
        interface: selectedInterface,
        targets: params.targets,
        mode: 'wpa',
        duration: params.duration,
      });
      return res.data;
    },
    onSuccess: (data) => {
      setCaptureStatus(data.message || 'Capture en cours...');
    },
    onError: (err: any) => {
      setIsCapturing(false);
      setCaptureStatus(`Erreur: ${err.response?.data?.error || err.message}`);
    },
  });

  // Stop capture mutation
  const stopCaptureMutation = useMutation({
    mutationFn: async () => {
      setCaptureStatus('‚è≥ Arr√™t en cours... (envoi de la requ√™te)');
      const res = await apiClient.post('/plugins/wifi/capture/stop');
      return res.data;
    },
    onMutate: () => {
      setCaptureStatus('‚è≥ Demande d\'arr√™t envoy√©e au serveur...');
    },
    onSuccess: (data) => {
      setIsCapturing(false);
      setCaptureStatus(`‚úÖ ${data.message || 'Capture arr√™t√©e'}`);
      refetchInterfaces();
    },
    onError: (err: any) => {
      setCaptureStatus(`‚ùå Erreur arr√™t: ${err.response?.data?.error || err.message}`);
    },
  });

  // Reconnect WiFi mutation (disable monitor mode)
  const reconnectMutation = useMutation({
    mutationFn: async () => {
      const res = await apiClient.post('/plugins/wifi/reconnect', {
        interface: selectedInterface,
      });
      return res.data;
    },
    onSuccess: (data) => {
      setIsCapturing(false);
      setCaptureStatus(data.message || 'WiFi reconnect√©');
      refetchInterfaces();
    },
    onError: (err: any) => {
      setCaptureStatus(`Erreur reconnexion: ${err.response?.data?.error || err.message}`);
    },
  });

  // ========== BRUTEFORCE SECTION ==========

  // Fetch captures list
  const { data: capturesData, refetch: refetchCaptures } = useQuery({
    queryKey: ['wifi', 'captures'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/captures');
      return res.data?.captures as CaptureFile[];
    },
    refetchInterval: activeTab === 'captures' || activeTab === 'crack' ? 5000 : false,
  });

  // Fetch wordlists
  const { data: wordlistsData } = useQuery({
    queryKey: ['wifi', 'wordlists'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/wordlists');
      return res.data?.wordlists as Wordlist[];
    },
  });

  // Fetch bruteforce status
  const { data: bruteforceStatus, refetch: refetchBruteforce } = useQuery({
    queryKey: ['wifi', 'bruteforce', 'status'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/bruteforce/status');
      return res.data as BruteforceStatus;
    },
    refetchInterval: activeTab === 'crack' ? 2000 : false,
  });

  // Fetch bruteforce results history
  const { data: bruteforceResults, refetch: refetchBruteResults } = useQuery({
    queryKey: ['wifi', 'bruteforce', 'results'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/bruteforce/results');
      return res.data?.results as BruteforceResult[];
    },
    refetchInterval: activeTab === 'crack' ? 10000 : false,
  });

  // Mettre √† jour l'√©tat isCapturing et le statut bas√© sur le polling
  useEffect(() => {
    if (captureStatusData) {
      const running = captureStatusData.running;
      const hasHandshake = captureStatusData.has_handshake;
      const capSize = captureStatusData.cap_size || 0;
      
      if (running !== isCapturing) {
        setIsCapturing(running);
        if (!running && isCapturing) {
          // La capture vient de se terminer
          if (hasHandshake) {
            setCaptureStatus('‚úÖ Capture termin√©e - Handshake captur√© !');
          } else {
            setCaptureStatus('‚èπÔ∏è Capture termin√©e - Aucun handshake');
          }
          refetchCaptures();
        }
      }
      
      if (running) {
        const targets = captureStatusData.targets?.length || 0;
        const sizeKB = (capSize / 1024).toFixed(1);
        setCaptureStatus(
          `üì° Capture en cours... ${targets} cible(s) | ${sizeKB} KB captur√©s${hasHandshake ? ' | üéâ Handshake d√©tect√©!' : ''}`
        );
      }
    }
  }, [captureStatusData, isCapturing, refetchCaptures]);

  // Auto-select first wordlist
  useEffect(() => {
    if (wordlistsData?.length && !selectedWordlist) {
      // Prioritize rockyou.txt
      const rockyou = wordlistsData.find((w) => w.name.includes('rockyou'));
      setSelectedWordlist(rockyou?.path || wordlistsData[0].path);
    }
  }, [wordlistsData, selectedWordlist]);

  // Bruteforce start mutation
  const bruteMutation = useMutation({
    mutationFn: async () => {
      const res = await apiClient.post('/plugins/wifi/bruteforce', {
        capture_path: selectedCapture,
        wordlist: selectedWordlist,
        bssid: targetBssid,
        ssid: targetSsid,
      });
      return res.data;
    },
    onSuccess: () => {
      refetchBruteforce();
    },
  });

  // Bruteforce stop mutation
  const bruteStopMutation = useMutation({
    mutationFn: async () => {
      const res = await apiClient.post('/plugins/wifi/bruteforce/stop');
      return res.data;
    },
    onSuccess: () => {
      refetchBruteforce();
      refetchBruteResults();
    },
  });

  // ========== DEAUTH MUTATIONS ==========

  // Deauth status query
  const { data: deauthStatus, refetch: refetchDeauth } = useQuery({
    queryKey: ['wifi', 'deauth', 'status'],
    queryFn: async () => {
      const res = await apiClient.get('/plugins/wifi/deauth/status');
      return res.data;
    },
    refetchInterval: isDeauthing ? 1000 : false,
  });

  // Sync deauth state
  useEffect(() => {
    if (deauthStatus?.running !== isDeauthing) {
      setIsDeauthing(deauthStatus?.running || false);
    }
  }, [deauthStatus?.running]); // eslint-disable-line react-hooks/exhaustive-deps

  // Deauth start mutation
  const deauthMutation = useMutation({
    mutationFn: async (params: { bssid: string; channel: number; count: number }) => {
      setIsDeauthing(true);
      const res = await apiClient.post('/plugins/wifi/deauth', {
        interface: selectedInterface,
        bssid: params.bssid,
        count: params.count,
        channel: params.channel,
      });
      return res.data;
    },
    onSuccess: (data) => {
      setCaptureStatus(`‚ö° Deauth: ${data.message}`);
      refetchDeauth();
    },
    onError: (err: any) => {
      setIsDeauthing(false);
      setCaptureStatus(`‚ùå Deauth erreur: ${err.response?.data?.error || err.message}`);
    },
  });

  // Deauth stop mutation
  const deauthStopMutation = useMutation({
    mutationFn: async () => {
      const res = await apiClient.post('/plugins/wifi/deauth/stop');
      return res.data;
    },
    onSuccess: () => {
      setIsDeauthing(false);
      setCaptureStatus('‚èπÔ∏è Deauth arr√™t√©');
      refetchDeauth();
    },
  });

  // Vendor analysis mutation
  const analyzeVendorMutation = useMutation({
    mutationFn: async (params: { bssid: string; ssid: string }) => {
      const res = await apiClient.post('/plugins/wifi/analyze', params);
      return res.data as VendorAnalysis;
    },
    onSuccess: (data) => {
      setVendorAnalysis(data);
      setShowVendorModal(true);
    },
    onError: (err: any) => {
      setCaptureStatus(`‚ùå Analyse erreur: ${err.response?.data?.error || err.message}`);
    },
  });

  // Helper to format file size
  const formatSize = (bytes: number) => {
    if (bytes < 1024) return `${bytes} B`;
    if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(1)} KB`;
    return `${(bytes / (1024 * 1024)).toFixed(1)} MB`;
  };

  // Helper to format duration
  const formatDuration = (seconds: number) => {
    if (seconds < 60) return `${Math.round(seconds)}s`;
    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ${Math.round(seconds % 60)}s`;
    return `${Math.floor(seconds / 3600)}h ${Math.floor((seconds % 3600) / 60)}m`;
  };

  const toggleNetwork = (bssid: string) => {
    const newSet = new Set(selectedNetworks);
    if (newSet.has(bssid)) {
      newSet.delete(bssid);
    } else {
      newSet.add(bssid);
    }
    setSelectedNetworks(newSet);
  };

  const selectAll = () => {
    if (selectedNetworks.size === networks.length) {
      setSelectedNetworks(new Set());
    } else {
      setSelectedNetworks(new Set(networks.map((n) => n.bssid)));
    }
  };

  // Ouvrir la modal de confirmation avec les r√©seaux s√©lectionn√©s
  const openCaptureModal = () => {
    if (selectedNetworks.size === 0) {
      alert('S√©lectionnez au moins un r√©seau');
      return;
    }
    
    // Initialiser les configs pour chaque r√©seau s√©lectionn√©
    const configs: NetworkCaptureDuration[] = [];
    selectedNetworks.forEach((bssid) => {
      const network = networks.find((n) => n.bssid === bssid);
      if (network) {
        // Dur√©e par d√©faut bas√©e sur le type de s√©curit√©
        let defaultDuration = 300; // 5 min par d√©faut
        if (network.security.includes('WPA3')) {
          defaultDuration = 1800; // 30 min pour WPA3
        } else if (network.security.includes('WEP')) {
          defaultDuration = 1800; // 30 min pour WEP
        }
        configs.push({
          bssid: network.bssid,
          ssid: network.ssid || '(cach√©)',
          duration: defaultDuration,
        });
      }
    });
    
    setCaptureConfigs(configs);
    setShowCaptureModal(true);
  };

  // Mettre √† jour la dur√©e d'un r√©seau
  const updateNetworkDuration = (bssid: string, duration: number) => {
    setCaptureConfigs((prev) =>
      prev.map((c) => (c.bssid === bssid ? { ...c, duration } : c))
    );
  };

  // Appliquer la m√™me dur√©e √† tous
  const applyDurationToAll = (duration: number) => {
    setCaptureConfigs((prev) => prev.map((c) => ({ ...c, duration })));
  };

  // Lancer la capture apr√®s confirmation
  const confirmCapture = () => {
    // Utiliser la dur√©e maximale parmi les r√©seaux s√©lectionn√©s
    const maxDuration = Math.max(...captureConfigs.map((c) => c.duration));
    const targets = captureConfigs.map((c) => c.bssid);
    
    setShowCaptureModal(false);
    captureMutation.mutate({ targets, duration: maxDuration });
  };

  const getSignalStrength = (signal: number) => {
    if (signal >= -50) return { label: 'Excellent', color: 'text-green-600', bars: 4 };
    if (signal >= -60) return { label: 'Bon', color: 'text-green-500', bars: 3 };
    if (signal >= -70) return { label: 'Moyen', color: 'text-yellow-500', bars: 2 };
    return { label: 'Faible', color: 'text-red-500', bars: 1 };
  };

  const getSecurityIcon = (security: string) => {
    if (security === 'open') {
      return <Unlock className="h-4 w-4 text-red-500" />;
    }
    return <Lock className="h-4 w-4 text-green-600" />;
  };

  // Modal de confirmation de capture
  const renderCaptureModal = () => {
    if (!showCaptureModal) return null;

    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center">
        {/* Backdrop */}
        <div 
          className="absolute inset-0 bg-black/50 backdrop-blur-sm"
          onClick={() => setShowCaptureModal(false)}
        />
        
        {/* Modal */}
        <div className="relative bg-white rounded-xl shadow-2xl max-w-2xl w-full mx-4 max-h-[80vh] overflow-hidden">
          {/* Header */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-gray-50">
            <div>
              <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <Download className="h-5 w-5 text-primary-600" />
                Confirmer la capture
              </h3>
              <p className="text-sm text-gray-500 mt-1">
                Configurez la dur√©e de capture pour chaque r√©seau
              </p>
            </div>
            <button 
              onClick={() => setShowCaptureModal(false)}
              className="p-2 hover:bg-gray-200 rounded-lg transition-colors"
            >
              <X className="h-5 w-5 text-gray-500" />
            </button>
          </div>
          
          {/* Body */}
          <div className="px-6 py-4 max-h-[50vh] overflow-y-auto">
            {/* Appliquer √† tous */}
            <div className="mb-4 p-3 bg-blue-50 rounded-lg">
              <div className="flex items-center justify-between">
                <span className="text-sm font-medium text-blue-800">Appliquer √† tous :</span>
                <div className="flex gap-2 flex-wrap">
                  {DURATION_OPTIONS.slice(0, 4).map((opt) => (
                    <button
                      key={opt.value}
                      onClick={() => applyDurationToAll(opt.value)}
                      className="px-3 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-700 hover:bg-blue-200 transition-colors"
                    >
                      {opt.label}
                    </button>
                  ))}
                </div>
              </div>
            </div>

            {/* Liste des r√©seaux */}
            <div className="space-y-3">
              {captureConfigs.map((config) => {
                const network = networks.find((n) => n.bssid === config.bssid);
                const signalInfo = network ? getSignalStrength(network.signal) : null;
                
                return (
                  <div 
                    key={config.bssid}
                    className="p-4 border border-gray-200 rounded-lg hover:border-primary-300 transition-colors"
                  >
                    <div className="flex items-center justify-between gap-4">
                      {/* Info r√©seau */}
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center gap-2">
                          <Wifi className={`h-4 w-4 ${signalInfo?.color || 'text-gray-400'}`} />
                          <span className="font-medium truncate">{config.ssid}</span>
                          {network && (
                            <span className="px-2 py-0.5 text-xs rounded-full bg-gray-100 text-gray-600">
                              {network.security}
                            </span>
                          )}
                        </div>
                        <p className="text-xs text-gray-500 mt-1 font-mono">{config.bssid}</p>
                      </div>
                      
                      {/* S√©lecteur dur√©e */}
                      <div className="flex-shrink-0">
                        <select
                          value={config.duration}
                          onChange={(e) => updateNetworkDuration(config.bssid, parseInt(e.target.value))}
                          className="rounded-lg border-gray-300 text-sm focus:border-primary-500 focus:ring-primary-500"
                        >
                          {DURATION_OPTIONS.map((opt) => (
                            <option key={opt.value} value={opt.value}>
                              {opt.label} {opt.hint && `(${opt.hint})`}
                            </option>
                          ))}
                        </select>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>
          
          {/* Footer */}
          <div className="flex items-center justify-between px-6 py-4 border-t border-gray-200 bg-gray-50">
            <div className="text-sm text-gray-500">
              <Clock className="h-4 w-4 inline mr-1" />
              Dur√©e max : {DURATION_OPTIONS.find((o) => o.value === Math.max(...captureConfigs.map((c) => c.duration)))?.label || 'Illimit√©'}
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowCaptureModal(false)}
                className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
              >
                Annuler
              </button>
              <button
                onClick={confirmCapture}
                className="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2"
              >
                <Play className="h-4 w-4" />
                Lancer la capture ({captureConfigs.length} r√©seau{captureConfigs.length > 1 ? 'x' : ''})
              </button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  // Modal de confirmation Deauth
  const renderDeauthModal = () => {
    if (!deauthTarget) return null;

    return (
      <div className="fixed inset-0 z-50 flex items-center justify-center">
        {/* Backdrop */}
        <div 
          className="absolute inset-0 bg-black/50 backdrop-blur-sm"
          onClick={() => setDeauthTarget(null)}
        />
        
        {/* Modal */}
        <div className="relative bg-white rounded-xl shadow-2xl max-w-md w-full mx-4">
          {/* Header */}
          <div className="flex items-center justify-between px-6 py-4 border-b border-gray-200 bg-orange-50">
            <div>
              <h3 className="text-lg font-semibold text-gray-900 flex items-center gap-2">
                <Zap className="h-5 w-5 text-orange-600" />
                Deauth Attack
              </h3>
              <p className="text-sm text-gray-500 mt-1">
                Forcer la d√©connexion des clients
              </p>
            </div>
            <button 
              onClick={() => setDeauthTarget(null)}
              className="p-2 hover:bg-orange-100 rounded-lg transition-colors"
            >
              <X className="h-5 w-5 text-gray-500" />
            </button>
          </div>
          
          {/* Body */}
          <div className="px-6 py-4 space-y-4">
            {/* Infos r√©seau */}
            <div className="p-3 bg-gray-50 rounded-lg">
              <div className="flex items-center gap-3">
                <Wifi className="h-5 w-5 text-primary-600" />
                <div>
                  <div className="font-medium">{deauthTarget.ssid || '(SSID cach√©)'}</div>
                  <div className="text-sm text-gray-500 font-mono">{deauthTarget.bssid}</div>
                  <div className="text-xs text-gray-400">Canal {deauthTarget.channel}</div>
                </div>
              </div>
            </div>

            {/* Explication */}
            <div className="p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
              <p className="text-sm text-yellow-800">
                <strong>‚ö° Qu&apos;est-ce que le deauth ?</strong><br />
                Cette attaque envoie des paquets de d√©connexion aux clients WiFi connect√©s √† ce r√©seau.
                Ils se reconnecteront automatiquement, ce qui g√©n√®re un <strong>handshake</strong> que vous pourrez capturer.
              </p>
            </div>

            {/* Nombre de paquets */}
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Nombre de paquets deauth
              </label>
              <select
                value={deauthCount}
                onChange={(e) => setDeauthCount(parseInt(e.target.value))}
                className="w-full rounded-lg border-gray-300 text-sm focus:border-primary-500 focus:ring-primary-500"
              >
                <option value={5}>5 paquets (rapide)</option>
                <option value={10}>10 paquets (recommand√©)</option>
                <option value={20}>20 paquets</option>
                <option value={50}>50 paquets (agressif)</option>
                <option value={100}>100 paquets (tr√®s agressif)</option>
              </select>
              <p className="text-xs text-gray-500 mt-1">
                Plus de paquets = plus de chances de capturer le handshake
              </p>
            </div>

            {/* Avertissement */}
            <div className="p-3 bg-red-50 border border-red-200 rounded-lg">
              <p className="text-xs text-red-700">
                ‚ö†Ô∏è <strong>Usage l√©gal uniquement</strong>. Utilisez cette fonctionnalit√© uniquement sur des r√©seaux que vous √™tes autoris√© √† tester.
              </p>
            </div>
          </div>
          
          {/* Footer */}
          <div className="flex items-center justify-end gap-3 px-6 py-4 border-t border-gray-200 bg-gray-50">
            <button
              onClick={() => setDeauthTarget(null)}
              className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
            >
              Annuler
            </button>
            <button
              onClick={() => {
                deauthMutation.mutate({
                  bssid: deauthTarget.bssid,
                  channel: deauthTarget.channel,
                  count: deauthCount,
                });
                setDeauthTarget(null);
              }}
              disabled={!selectedInterface}
              className="px-4 py-2 text-sm font-medium text-white bg-orange-600 rounded-lg hover:bg-orange-700 transition-colors flex items-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <Zap className="h-4 w-4" />
              Lancer le Deauth
            </button>
          </div>
        </div>
      </div>
    );
  };

  // Render scan tab content
  const renderScanTab = () => (
    <>
      {/* Interface selector + Scan button */}
      <div className="card">
        <div className="flex flex-wrap items-end gap-4">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-sm font-medium text-gray-700 mb-1">
              Interface Wi-Fi
            </label>
            <div className="flex gap-2">
              <select
                value={selectedInterface}
                onChange={(e) => setSelectedInterface(e.target.value)}
                className="flex-1 rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
              >
                <option value="">Choisir une interface</option>
                {interfacesData?.map((iface) => (
                  <option key={iface.name} value={iface.name} disabled={!iface.up}>
                    {iface.name}
                    {iface.monitor ? ' [monitor]' : ''}
                    {iface.driver ? ` (${iface.driver})` : ''}
                    {!iface.up ? ' - DOWN' : ''}
                  </option>
                ))}
              </select>
              <button
                onClick={() => refetchInterfaces()}
                disabled={isRefreshingInterfaces}
                className="px-3 py-2 rounded-md border border-gray-300 bg-white hover:bg-gray-50 text-gray-700 transition-colors disabled:opacity-50"
                title="Rafra√Æchir les interfaces"
              >
                <RefreshCw className={`h-4 w-4 ${isRefreshingInterfaces ? 'animate-spin' : ''}`} />
              </button>
            </div>
          </div>

          <button
            onClick={() => scanMutation.mutate()}
            disabled={!selectedInterface || isScanning}
            className="btn btn-primary flex items-center gap-2"
          >
            {isScanning ? <Loader2 className="h-4 w-4 animate-spin" /> : <Radio className="h-4 w-4" />}
            {isScanning ? 'Scan...' : 'Scanner'}
          </button>

          <button
            onClick={openCaptureModal}
            disabled={selectedNetworks.size === 0 || isCapturing || !selectedInterface}
            className="btn btn-danger flex items-center gap-2"
          >
            {isCapturing ? <Loader2 className="h-4 w-4 animate-spin" /> : <Download className="h-4 w-4" />}
            Capturer ({selectedNetworks.size})
          </button>

          {isCapturing && (
            <button onClick={() => stopCaptureMutation.mutate()} disabled={stopCaptureMutation.isPending} className="btn btn-secondary flex items-center gap-2">
              <StopCircle className="h-4 w-4" />
              Arr√™ter
            </button>
          )}

          <button
            onClick={() => reconnectMutation.mutate()}
            disabled={reconnectMutation.isPending || !selectedInterface}
            className="btn btn-secondary flex items-center gap-2"
            title="Reconnecter WiFi"
          >
            {reconnectMutation.isPending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Wifi className="h-4 w-4" />}
            Reconnecter
          </button>

          {/* Bouton Stop Deauth si en cours */}
          {isDeauthing && (
            <button
              onClick={() => deauthStopMutation.mutate()}
              disabled={deauthStopMutation.isPending}
              className="btn bg-orange-600 text-white hover:bg-orange-700 flex items-center gap-2"
            >
              {deauthStopMutation.isPending ? <Loader2 className="h-4 w-4 animate-spin" /> : <StopCircle className="h-4 w-4" />}
              Stop Deauth
            </button>
          )}
        </div>

        {/* Statut capture/deauth */}
        {(captureStatus || isDeauthing) && (
          <div className={`mt-4 p-3 rounded-lg flex items-center justify-between ${
            captureStatus?.includes('Erreur') ? 'bg-red-50 text-red-700' : 
            isDeauthing ? 'bg-orange-50 text-orange-700' :
            isCapturing ? 'bg-yellow-50 text-yellow-700' : 'bg-blue-50 text-blue-700'
          }`}>
            <span className="flex items-center gap-2">
              {isDeauthing && <Zap className="h-4 w-4 animate-pulse" />}
              {isDeauthing && deauthStatus?.bssid 
                ? `‚ö° Deauth en cours: ${deauthStatus.bssid} (${deauthStatus.sent || 0}/${deauthStatus.count || 0} paquets)`
                : captureStatus
              }
            </span>
            {isCapturing && <button onClick={() => stopCaptureMutation.mutate()} className="text-sm underline">Arr√™ter capture</button>}
            {isDeauthing && <button onClick={() => deauthStopMutation.mutate()} className="text-sm underline">Arr√™ter deauth</button>}
          </div>
        )}
      </div>

      {/* Networks table */}
      <div className="card p-0 overflow-hidden">
        <div className="px-6 py-4 border-b border-gray-200 bg-gray-50 flex justify-between items-center">
          <h3 className="font-semibold">R√©seaux d√©tect√©s ({networks.length})</h3>
          <button onClick={selectAll} className="text-sm text-primary-600 hover:text-primary-700 flex items-center gap-1">
            <CheckSquare className="h-4 w-4" />
            {selectedNetworks.size === networks.length ? 'Tout d√©s√©lectionner' : 'Tout s√©lectionner'}
          </button>
        </div>

        {networks.length === 0 ? (
          <div className="p-12 text-center text-gray-500">
            <Radio className="h-12 w-12 mx-auto mb-4 text-gray-300" />
            <p>Aucun r√©seau d√©tect√©</p>
            <p className="text-sm mt-1">Cliquez sur Scanner pour d√©tecter les r√©seaux</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-4 py-3 text-left">
                    <input type="checkbox" checked={selectedNetworks.size === networks.length && networks.length > 0} onChange={selectAll} className="rounded border-gray-300 text-primary-600 focus:ring-primary-500" />
                  </th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">SSID</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">BSSID</th>
                  <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Canal</th>
                  <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Signal</th>
                  <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">S√©curit√©</th>
                  <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fabricant</th>
                  <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">WPS</th>
                  <th className="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {networks.map((network, index) => {
                  const signalInfo = getSignalStrength(network.signal);
                  const isSelected = selectedNetworks.has(network.bssid);
                  return (
                    <tr key={`${network.bssid}-${index}`} onClick={() => toggleNetwork(network.bssid)} className={`cursor-pointer transition-colors ${isSelected ? 'bg-primary-50 hover:bg-primary-100' : 'hover:bg-gray-50'}`}>
                      <td className="px-4 py-3">
                        <input type="checkbox" checked={isSelected} onChange={() => toggleNetwork(network.bssid)} onClick={(e) => e.stopPropagation()} className="rounded border-gray-300 text-primary-600 focus:ring-primary-500" />
                      </td>
                      <td className="px-4 py-3">
                        <div className="flex items-center gap-2">
                          <Wifi className={`h-4 w-4 ${signalInfo.color}`} />
                          <span className="font-medium">{network.ssid || <span className="text-gray-400 italic">(cach√©)</span>}</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 font-mono text-sm text-gray-600">{network.bssid}</td>
                      <td className="px-4 py-3 text-center"><span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100">{network.channel}</span></td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">
                          <Signal className={`h-4 w-4 ${signalInfo.color}`} />
                          <span className={`text-sm ${signalInfo.color}`}>{network.signal} dBm</span>
                        </div>
                      </td>
                      <td className="px-4 py-3 text-center">
                        <div className="flex items-center justify-center gap-1">{getSecurityIcon(network.security)}<span className="text-sm">{network.security}</span></div>
                      </td>
                      <td className="px-4 py-3 text-left">
                        <div className="flex items-center gap-2">
                          {network.vendor ? (
                            <span className={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                              network.vendor === 'Free' ? 'bg-red-100 text-red-700' :
                              network.vendor === 'Orange' ? 'bg-orange-100 text-orange-700' :
                              network.vendor === 'SFR' ? 'bg-green-100 text-green-700' :
                              network.vendor === 'Bouygues' ? 'bg-blue-100 text-blue-700' :
                              'bg-gray-100 text-gray-700'
                            }`}>
                              {network.vendor}
                            </span>
                          ) : (
                            <span className="text-gray-400 text-sm">-</span>
                          )}
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              analyzeVendorMutation.mutate({ bssid: network.bssid, ssid: network.ssid });
                            }}
                            disabled={analyzeVendorMutation.isPending}
                            className="text-primary-600 hover:text-primary-800 p-1"
                            title="Analyser le pattern de mot de passe"
                          >
                            {analyzeVendorMutation.isPending ? (
                              <Loader2 className="h-3 w-3 animate-spin" />
                            ) : (
                              <Info className="h-3 w-3" />
                            )}
                          </button>
                        </div>}
                      </td>
                      <td className="px-4 py-3 text-center">
                        {network.wps ? <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">WPS</span> : <span className="text-gray-400">-</span>}
                      </td>
                      <td className="px-4 py-3 text-center">
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setDeauthTarget({ bssid: network.bssid, ssid: network.ssid, channel: network.channel });
                          }}
                          disabled={isDeauthing && deauthStatus?.bssid !== network.bssid}
                          className={`inline-flex items-center gap-1 px-2 py-1 rounded text-xs font-medium transition-colors ${
                            isDeauthing && deauthStatus?.bssid === network.bssid
                              ? 'bg-red-100 text-red-700 animate-pulse'
                              : 'bg-orange-100 text-orange-700 hover:bg-orange-200'
                          }`}
                          title="Deauth Attack - Force les clients √† se reconnecter"
                        >
                          <Zap className="h-3 w-3" />
                          {isDeauthing && deauthStatus?.bssid === network.bssid ? 'Deauth...' : 'Deauth'}
                        </button>
                      </td>
                    </tr>
                  );
                })}
              </tbody>
            </table>
          </div>
        )}
      </div>
    </>
  );

  // Render captures tab content
  const renderCapturesTab = () => (
    <div className="card">
      <div className="flex justify-between items-center mb-4">
        <h3 className="font-semibold text-lg flex items-center gap-2">
          <FileText className="h-5 w-5 text-primary-600" />
          Fichiers de capture
        </h3>
        <button onClick={() => refetchCaptures()} className="btn btn-secondary btn-sm flex items-center gap-1">
          <RefreshCw className="h-4 w-4" /> Actualiser
        </button>
      </div>

      {!capturesData || capturesData.length === 0 ? (
        <div className="text-center py-8 text-gray-500">
          <FileText className="h-12 w-12 mx-auto mb-4 text-gray-300" />
          <p>Aucune capture disponible</p>
          <p className="text-sm mt-1">Lancez une capture dans l&apos;onglet Scan</p>
        </div>
      ) : (
        <div className="space-y-3">
          {capturesData.map((cap) => (
            <div key={cap.path} className={`p-4 rounded-lg border ${cap.cracked ? 'border-purple-300 bg-purple-50' : cap.has_handshake ? 'border-green-300 bg-green-50' : 'border-gray-200 bg-gray-50'}`}>
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  {cap.cracked ? <Key className="h-5 w-5 text-purple-600" /> : cap.has_handshake ? <CheckCircle className="h-5 w-5 text-green-600" /> : <Clock className="h-5 w-5 text-gray-400" />}
                  <div>
                    <div className="flex items-center gap-2">
                      <p className="font-medium">{cap.ssid || cap.name}</p>
                      {cap.security && (
                        <span className="text-xs px-1.5 py-0.5 rounded bg-orange-100 text-orange-700">{cap.security}</span>
                      )}
                      {cap.status === 'running' && (
                        <span className="text-xs px-1.5 py-0.5 rounded bg-blue-100 text-blue-700 animate-pulse">En cours</span>
                      )}
                    </div>
                    <div className="text-sm text-gray-500 space-x-2">
                      {cap.bssid && <span>{cap.bssid}</span>}
                      {cap.channel && <span>‚Ä¢ CH {cap.channel}</span>}
                      <span>‚Ä¢ {formatSize(cap.size)}</span>
                      {cap.started_at && <span>‚Ä¢ {new Date(cap.started_at).toLocaleString()}</span>}
                    </div>
                  </div>
                </div>
                <div className="flex items-center gap-2">
                  {cap.has_handshake && (
                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                      <Key className="h-3 w-3 mr-1" /> Handshake
                    </span>
                  )}
                  {cap.cracked && cap.password && (
                    <span className="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                      üîì {cap.password}
                    </span>
                  )}
                  <button
                    onClick={() => {
                      // Utiliser le fichier .cap s'il existe, sinon le path de base
                      const capturePath = cap.cap_file || cap.path;
                      setSelectedCapture(capturePath);
                      // Pr√©-remplir SSID et BSSID depuis la capture
                      if (cap.ssid) setTargetSsid(cap.ssid);
                      if (cap.bssid) setTargetBssid(cap.bssid);
                      setActiveTab('crack');
                    }}
                    disabled={!cap.has_handshake}
                    className="btn btn-sm btn-primary disabled:opacity-50 disabled:cursor-not-allowed"
                  >
                    <Zap className="h-4 w-4 mr-1" /> Cracker
                  </button>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );

  // Render crack/bruteforce tab content
  const renderCrackTab = () => (
    <div className="space-y-6">
      {/* Bruteforce status */}
      {bruteforceStatus?.running && (
        <div className="card bg-yellow-50 border-yellow-300">
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-3">
              <Loader2 className="h-6 w-6 text-yellow-600 animate-spin" />
              <div>
                <h4 className="font-semibold text-yellow-900">Bruteforce en cours...</h4>
                <p className="text-sm text-yellow-700">
                  Dur√©e: {formatDuration(bruteforceStatus.duration || 0)}
                </p>
              </div>
            </div>
            <button onClick={() => bruteStopMutation.mutate()} disabled={bruteStopMutation.isPending} className="btn btn-danger">
              <StopCircle className="h-4 w-4 mr-1" /> Arr√™ter
            </button>
          </div>
        </div>
      )}

      {/* Last result */}
      {bruteforceStatus?.result && (
        <div className={`card ${bruteforceStatus.result.success ? 'bg-green-50 border-green-300' : 'bg-red-50 border-red-300'}`}>
          <div className="flex items-center gap-3">
            {bruteforceStatus.result.success ? (
              <CheckCircle className="h-8 w-8 text-green-600" />
            ) : (
              <XCircle className="h-8 w-8 text-red-600" />
            )}
            <div>
              <h4 className={`font-semibold ${bruteforceStatus.result.success ? 'text-green-900' : 'text-red-900'}`}>
                {bruteforceStatus.result.success ? 'üéâ Mot de passe trouv√© !' : 'Mot de passe non trouv√©'}
              </h4>
              {bruteforceStatus.result.success && (
                <p className="text-2xl font-mono font-bold text-green-800 mt-1">{bruteforceStatus.result.password}</p>
              )}
              <p className="text-sm mt-1">
                SSID: {bruteforceStatus.result.ssid} ‚Ä¢ Dur√©e: {formatDuration(bruteforceStatus.result.duration_seconds)}
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Bruteforce form */}
      <div className="card">
        <h3 className="font-semibold text-lg flex items-center gap-2 mb-4">
          <Key className="h-5 w-5 text-primary-600" />
          Lancer un bruteforce
        </h3>

        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Fichier capture (.cap)</label>
            <select
              value={selectedCapture}
              onChange={(e) => setSelectedCapture(e.target.value)}
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >
              <option value="">S√©lectionner une capture</option>
              {capturesData?.filter((c) => c.has_handshake).map((cap) => (
                <option key={cap.path} value={cap.path}>{cap.name}</option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">Wordlist</label>
            <select
              value={selectedWordlist}
              onChange={(e) => setSelectedWordlist(e.target.value)}
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            >
              <option value="">S√©lectionner une wordlist</option>
              {wordlistsData?.map((wl) => (
                <option key={wl.path} value={wl.path}>
                  {wl.name} ({wl.lines > 0 ? `${(wl.lines / 1000000).toFixed(1)}M mots` : formatSize(wl.size)})
                </option>
              ))}
            </select>
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">BSSID (MAC du point d&apos;acc√®s)</label>
            <input
              type="text"
              value={targetBssid}
              onChange={(e) => setTargetBssid(e.target.value)}
              placeholder="00:11:22:33:44:55"
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700 mb-1">SSID (Nom du r√©seau)</label>
            <input
              type="text"
              value={targetSsid}
              onChange={(e) => setTargetSsid(e.target.value)}
              placeholder="MonReseau"
              className="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500"
            />
          </div>
        </div>

        <div className="mt-6 flex justify-end">
          <button
            onClick={() => bruteMutation.mutate()}
            disabled={!selectedCapture || !selectedWordlist || !targetBssid || bruteforceStatus?.running || bruteMutation.isPending}
            className="btn btn-primary flex items-center gap-2 disabled:opacity-50"
          >
            {bruteMutation.isPending ? <Loader2 className="h-4 w-4 animate-spin" /> : <Zap className="h-4 w-4" />}
            Lancer le bruteforce
          </button>
        </div>
      </div>

      {/* Results history */}
      {bruteforceResults && bruteforceResults.length > 0 && (
        <div className="card">
          <h3 className="font-semibold text-lg mb-4">Historique des attaques</h3>
          <div className="space-y-2">
            {bruteforceResults.map((result, idx) => (
              <div key={idx} className={`p-3 rounded-lg ${result.success ? 'bg-green-50' : 'bg-gray-50'}`}>
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    {result.success ? <CheckCircle className="h-4 w-4 text-green-600" /> : <XCircle className="h-4 w-4 text-gray-400" />}
                    <span className="font-medium">{result.ssid}</span>
                    {result.success && <span className="font-mono text-green-700 bg-green-100 px-2 py-0.5 rounded">{result.password}</span>}
                  </div>
                  <span className="text-sm text-gray-500">{new Date(result.tested_at).toLocaleString()}</span>
                </div>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-start">
        <div>
          <h1 className="text-2xl font-bold flex items-center gap-3">
            <Wifi className="h-7 w-7 text-primary-600" />
            Pentest Wi-Fi
          </h1>
          <p className="text-gray-500 mt-1">Scan, capture de handshakes et cracking WPA/WPA2</p>
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          <button
            onClick={() => setActiveTab('scan')}
            className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'scan' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
          >
            <Radio className="h-4 w-4 inline mr-2" />
            Scan & Capture
          </button>
          <button
            onClick={() => { setActiveTab('captures'); refetchCaptures(); }}
            className={`py-4 px-1 border-b-2 font-medium text-sm ${activeTab === 'captures' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
          >
            <FileText className="h-4 w-4 inline mr-2" />
            Captures ({capturesData?.length || 0})
          </button>
          <button
            onClick={() => { setActiveTab('crack'); refetchBruteforce(); }}
            className={`py-4 px-1 border-b-2 font-medium text-sm flex items-center ${activeTab === 'crack' ? 'border-primary-500 text-primary-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}`}
          >
            <Key className="h-4 w-4 inline mr-2" />
            Cracker
            {bruteforceStatus?.running && <Loader2 className="h-4 w-4 ml-2 animate-spin text-yellow-500" />}
          </button>
        </nav>
      </div>

      {/* Tab content */}
      {activeTab === 'scan' && renderScanTab()}
      {activeTab === 'captures' && renderCapturesTab()}
      {activeTab === 'crack' && renderCrackTab()}

      {/* Modal de confirmation de capture */}
      {renderCaptureModal()}

      {/* Modal de confirmation Deauth */}
      {renderDeauthModal()}

      {/* Modal d'analyse vendeur */}
      {showVendorModal && vendorAnalysis && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg shadow-xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div className="p-6">
              <div className="flex justify-between items-start mb-4">
                <h3 className="text-lg font-semibold flex items-center gap-2">
                  <Info className="h-5 w-5 text-primary-600" />
                  Analyse du r√©seau
                </h3>
                <button onClick={() => setShowVendorModal(false)} className="text-gray-400 hover:text-gray-600">
                  <X className="h-5 w-5" />
                </button>
              </div>

              <div className="space-y-4">
                {/* Network info */}
                <div className="bg-gray-50 rounded-lg p-4">
                  <div className="grid grid-cols-2 gap-2 text-sm">
                    <div className="text-gray-500">SSID</div>
                    <div className="font-medium">{vendorAnalysis.ssid || '(cach√©)'}</div>
                    <div className="text-gray-500">BSSID</div>
                    <div className="font-mono">{vendorAnalysis.bssid}</div>
                  </div>
                </div>

                {/* Vendor info */}
                {vendorAnalysis.vendor && (
                  <div className="border rounded-lg p-4">
                    <h4 className="font-medium mb-2">Fabricant d√©tect√©</h4>
                    <div className="grid grid-cols-2 gap-2 text-sm">
                      <div className="text-gray-500">Fabricant</div>
                      <div>{vendorAnalysis.vendor.manufacturer}</div>
                      {vendorAnalysis.isp && (
                        <>
                          <div className="text-gray-500">FAI</div>
                          <div className={`font-medium ${
                            vendorAnalysis.isp === 'Free' ? 'text-red-600' :
                            vendorAnalysis.isp === 'Orange' ? 'text-orange-600' :
                            vendorAnalysis.isp === 'SFR' ? 'text-green-600' :
                            vendorAnalysis.isp === 'Bouygues' ? 'text-blue-600' :
                            'text-gray-900'
                          }`}>{vendorAnalysis.isp}</div>
                        </>
                      )}
                      {vendorAnalysis.vendor.router_model && (
                        <>
                          <div className="text-gray-500">Mod√®le</div>
                          <div>{vendorAnalysis.vendor.router_model}</div>
                        </>
                      )}
                    </div>
                  </div>
                )}

                {/* Password pattern */}
                {vendorAnalysis.has_pattern && vendorAnalysis.password_pattern && (
                  <div className="border-2 border-primary-200 bg-primary-50 rounded-lg p-4">
                    <h4 className="font-medium text-primary-900 mb-2 flex items-center gap-2">
                      <Key className="h-4 w-4" />
                      Pattern de mot de passe connu !
                    </h4>
                    <div className="space-y-2 text-sm">
                      <p className="text-primary-800">{vendorAnalysis.password_pattern.description}</p>
                      <div className="grid grid-cols-2 gap-2 text-primary-700">
                        <div>Longueur</div>
                        <div className="font-medium">{vendorAnalysis.password_pattern.length} caract√®res</div>
                        <div>Type</div>
                        <div className="font-medium">{vendorAnalysis.password_pattern.character_set}</div>
                      </div>
                      <div className="mt-3 p-2 bg-white rounded border">
                        <div className="text-xs text-gray-500 mb-1">Exemple de format :</div>
                        <code className="text-sm font-mono text-primary-900">{vendorAnalysis.password_pattern.example}</code>
                      </div>
                      {vendorAnalysis.password_pattern.mask_pattern && (
                        <div className="mt-2 p-2 bg-gray-100 rounded">
                          <div className="text-xs text-gray-500 mb-1">Masque hashcat :</div>
                          <code className="text-xs font-mono">{vendorAnalysis.password_pattern.mask_pattern}</code>
                        </div>
                      )}
                      {vendorAnalysis.password_pattern.notes && (
                        <p className="text-xs text-primary-600 mt-2 italic">{vendorAnalysis.password_pattern.notes}</p>
                      )}
                    </div>
                  </div>
                )}

                {!vendorAnalysis.has_pattern && vendorAnalysis.isp && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                    <p className="text-yellow-800 text-sm">
                      Aucun pattern de mot de passe connu pour ce FAI. Utilisez une wordlist g√©n√©rique.
                    </p>
                  </div>
                )}
              </div>

              <div className="mt-6 flex justify-end">
                <button onClick={() => setShowVendorModal(false)} className="btn btn-primary">
                  Fermer
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
